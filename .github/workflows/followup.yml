name: PR Comment Followup

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  followup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Prepare
        run: |
          npm init -y

      - name: Get PR info (resolve PR + comment)
        id: prinfo
        run: node .github/scripts/get-pr-info.js $GITHUB_EVENT_PATH
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}

      - name: Show PR info
        run: cat pr.json

      - name: Checkout PR branch
        run: |
          HEADREF=$(node -e "console.log(require('./pr.json').head_ref)")
          echo "Checking out branch: $HEADREF"
          git fetch origin $HEADREF:$HEADREF || git fetch origin refs/heads/$HEADREF:refs/heads/$HEADREF
          git checkout $HEADREF

      - name: Install runtime dependencies
        run: |
          npm init -y
          npm install @google/generative-ai

      - name: Run follow-up script
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: node .github/scripts/followup.js
